name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  test-template:
    runs-on: ubuntu-latest

    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_CACHE_DIR: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Cookiecutter
        run: |
          python -m pip install --upgrade pip
          pip install cookiecutter

      - name: Generate project from template
        run: |
          cookiecutter . --no-input

      - name: Create minimal training dataset
        working-directory: ./my_ml_project
        run: |
          mkdir -p data/processed
          cat > data/processed/train.csv << 'EOF'
          feature1,feature2,feature3,target
          0.1,1.0,0.5,0
          0.2,0.9,0.4,0
          0.3,0.8,0.3,0
          0.4,0.7,0.2,0
          0.5,0.6,0.1,0
          1.0,0.1,0.9,1
          0.9,0.2,0.8,1
          0.8,0.3,0.7,1
          0.7,0.4,0.6,1
          0.6,0.5,0.5,1
          0.15,0.95,0.45,0
          0.25,0.85,0.35,0
          0.35,0.75,0.25,0
          0.45,0.65,0.15,0
          0.55,0.55,0.05,0
          0.95,0.15,0.85,1
          0.85,0.25,0.75,1
          0.75,0.35,0.65,1
          0.65,0.45,0.55,1
          0.55,0.55,0.45,1
          EOF

      - name: Create virtualenv and install dependencies
        working-directory: ./my_ml_project
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .[dev]

      - name: Run tests
        working-directory: ./my_ml_project
        run: |
          source .venv/bin/activate
          pytest -q

      - name: Run training pipeline
        working-directory: ./my_ml_project
        run: |
          source .venv/bin/activate
          python -m mlpkg.pipelines.train
